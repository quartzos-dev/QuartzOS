#include <drivers/framebuffer.h>
#include <lib/string.h>
#include <memory/heap.h>

static uint8_t *g_fb;
static uint8_t *g_back;
static uint32_t g_width;
static uint32_t g_height;
static uint32_t g_pitch;
static uint32_t g_bpp;

static inline uint8_t *fb_surface(void) {
    return g_back ? g_back : g_fb;
}

static inline uint32_t pack_color32(uint32_t color) {
    return 0xFF000000u | (color & 0x00FFFFFFu);
}

static inline uint16_t pack_color565(uint32_t color) {
    uint8_t r = (uint8_t)((color >> 16) & 0xFFu);
    uint8_t g = (uint8_t)((color >> 8) & 0xFFu);
    uint8_t b = (uint8_t)(color & 0xFFu);
    return (uint16_t)(((uint16_t)(r >> 3) << 11) |
                      ((uint16_t)(g >> 2) << 5) |
                      ((uint16_t)(b >> 3)));
}

static inline uint32_t bytes_per_pixel(void) {
    if (g_bpp <= 8) {
        return 1;
    }
    if (g_bpp <= 16) {
        return 2;
    }
    if (g_bpp <= 24) {
        return 3;
    }
    return 4;
}

static inline void put_pixel_on_surface(uint8_t *surface, uint32_t x, uint32_t y, uint32_t color) {
    if (!surface || x >= g_width || y >= g_height) {
        return;
    }

    uint8_t *row = surface + (size_t)y * g_pitch;

    if (g_bpp == 32) {
        ((uint32_t *)row)[x] = pack_color32(color);
        return;
    }

    if (g_bpp == 24) {
        uint8_t *px = row + x * 3u;
        px[0] = (uint8_t)(color & 0xFFu);
        px[1] = (uint8_t)((color >> 8) & 0xFFu);
        px[2] = (uint8_t)((color >> 16) & 0xFFu);
        return;
    }

    if (g_bpp == 16) {
        ((uint16_t *)row)[x] = pack_color565(color);
        return;
    }

    ((uint32_t *)row)[x] = pack_color32(color);
}

static const uint8_t font8x8_basic[128][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x7E,0x81,0xA5,0x81,0xBD,0x99,0x81,0x7E},
    {0x7E,0xFF,0xDB,0xFF,0xC3,0xE7,0xFF,0x7E}, {0x6C,0xFE,0xFE,0xFE,0x7C,0x38,0x10,0x00},
    {0x10,0x38,0x7C,0xFE,0x7C,0x38,0x10,0x00}, {0x38,0x7C,0x38,0xFE,0xFE,0x92,0x10,0x7C},
    {0x10,0x38,0x7C,0xFE,0xFE,0x7C,0x10,0x38}, {0x00,0x00,0x18,0x3C,0x3C,0x18,0x00,0x00},
    {0xFF,0xFF,0xE7,0xC3,0xC3,0xE7,0xFF,0xFF}, {0x00,0x3C,0x66,0x42,0x42,0x66,0x3C,0x00},
    {0xFF,0xC3,0x99,0xBD,0xBD,0x99,0xC3,0xFF}, {0x0F,0x07,0x0F,0x7D,0xCC,0xCC,0xCC,0x78},
    {0x3C,0x66,0x66,0x66,0x3C,0x18,0x7E,0x18}, {0x3F,0x33,0x3F,0x30,0x30,0x70,0xF0,0xE0},
    {0x7F,0x63,0x7F,0x63,0x63,0x67,0xE6,0xC0}, {0x99,0x5A,0x3C,0xE7,0xE7,0x3C,0x5A,0x99},
    {0x80,0xE0,0xF8,0xFE,0xF8,0xE0,0x80,0x00}, {0x02,0x0E,0x3E,0xFE,0x3E,0x0E,0x02,0x00},
    {0x18,0x3C,0x7E,0x18,0x18,0x7E,0x3C,0x18}, {0x66,0x66,0x66,0x66,0x66,0x00,0x66,0x00},
    {0x7F,0xDB,0xDB,0x7B,0x1B,0x1B,0x1B,0x00}, {0x3E,0x63,0x38,0x6C,0x6C,0x38,0xCC,0x78},
    {0x00,0x00,0x00,0x00,0x7E,0x7E,0x7E,0x00}, {0x18,0x3C,0x7E,0x18,0x7E,0x3C,0x18,0xFF},
    {0x18,0x3C,0x7E,0x18,0x18,0x18,0x18,0x00}, {0x18,0x18,0x18,0x18,0x7E,0x3C,0x18,0x00},
    {0x00,0x18,0x0C,0xFE,0x0C,0x18,0x00,0x00}, {0x00,0x30,0x60,0xFE,0x60,0x30,0x00,0x00},
    {0x00,0x00,0xC0,0xC0,0xC0,0xFE,0x00,0x00}, {0x00,0x24,0x66,0xFF,0x66,0x24,0x00,0x00},
    {0x00,0x18,0x3C,0x7E,0xFF,0xFF,0x00,0x00}, {0x00,0xFF,0xFF,0x7E,0x3C,0x18,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00},
    {0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00}, {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00},
    {0x18,0x3E,0x58,0x3C,0x1A,0x7C,0x18,0x00}, {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00},
    {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00}, {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00},
    {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00}, {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00},
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00}, {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00},
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00}, {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00},
    {0x7C,0xC6,0xCE,0xDE,0xF6,0xE6,0x7C,0x00}, {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00},
    {0x7C,0xC6,0x06,0x1C,0x70,0xC0,0xFE,0x00}, {0x7C,0xC6,0x06,0x3C,0x06,0xC6,0x7C,0x00},
    {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00}, {0xFE,0xC0,0xFC,0x06,0x06,0xC6,0x7C,0x00},
    {0x3C,0x60,0xC0,0xFC,0xC6,0xC6,0x7C,0x00}, {0xFE,0xC6,0x0C,0x18,0x30,0x30,0x30,0x00},
    {0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00}, {0x7C,0xC6,0xC6,0x7E,0x06,0x0C,0x78,0x00},
    {0x00,0x18,0x18,0x00,0x18,0x18,0x00,0x00}, {0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00},
    {0x0E,0x1C,0x38,0x70,0x38,0x1C,0x0E,0x00}, {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00},
    {0x70,0x38,0x1C,0x0E,0x1C,0x38,0x70,0x00}, {0x7C,0xC6,0x0C,0x18,0x18,0x00,0x18,0x00},
    {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00}, {0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0x00},
    {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00}, {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00},
    {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00}, {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00},
    {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00}, {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3E,0x00},
    {0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0x00}, {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00},
    {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00}, {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00},
    {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00}, {0xC6,0xEE,0xFE,0xD6,0xC6,0xC6,0xC6,0x00},
    {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00}, {0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00},
    {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00}, {0x7C,0xC6,0xC6,0xC6,0xD6,0xCC,0x7A,0x00},
    {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00}, {0x7C,0xC6,0xE0,0x7C,0x0E,0xC6,0x7C,0x00},
    {0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00}, {0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00},
    {0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00}, {0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00},
    {0xC6,0xC6,0x6C,0x38,0x38,0x6C,0xC6,0x00}, {0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00},
    {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00}, {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00},
    {0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00}, {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00},
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00}, {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00}, {0x00,0x00,0x7C,0x06,0x7E,0xC6,0x7E,0x00},
    {0xE0,0x60,0x7C,0x66,0x66,0x66,0xDC,0x00}, {0x00,0x00,0x7C,0xC6,0xC0,0xC6,0x7C,0x00},
    {0x1C,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00}, {0x00,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00},
    {0x1C,0x36,0x30,0xFC,0x30,0x30,0x78,0x00}, {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8},
    {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00}, {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00},
    {0x0C,0x00,0x0C,0x0C,0x0C,0xCC,0xCC,0x78}, {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00},
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, {0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xC6,0x00},
    {0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00}, {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0x00},
    {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0}, {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E},
    {0x00,0x00,0xDC,0x76,0x60,0x60,0xF0,0x00}, {0x00,0x00,0x7E,0xC0,0x7C,0x06,0xFC,0x00},
    {0x10,0x30,0x7C,0x30,0x30,0x36,0x1C,0x00}, {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00},
    {0x00,0x00,0xC6,0xC6,0xC6,0x6C,0x38,0x00}, {0x00,0x00,0xC6,0xD6,0xD6,0xFE,0x6C,0x00},
    {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00}, {0x00,0x00,0xC6,0xC6,0xC6,0x7E,0x06,0xFC},
    {0x00,0x00,0xFE,0x4C,0x18,0x32,0xFE,0x00}, {0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00},
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, {0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00},
    {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00}, {0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0x00}
};

void framebuffer_init(void *address, uint32_t width, uint32_t height, uint32_t pitch, uint32_t bpp) {
    g_fb = (uint8_t *)address;
    g_back = 0;
    g_width = width;
    g_height = height;
    g_pitch = pitch;
    g_bpp = bpp;
}

static size_t framebuffer_bytes(void) {
    if (g_pitch == 0 || g_height == 0) {
        return 0;
    }
    if ((size_t)g_pitch > ((size_t)-1) / g_height) {
        return 0;
    }
    return (size_t)g_pitch * g_height;
}

bool fb_enable_backbuffer(void) {
    if (!g_fb) {
        return false;
    }
    if (g_back) {
        return true;
    }

    size_t bytes = framebuffer_bytes();
    if (bytes == 0) {
        return false;
    }

    g_back = (uint8_t *)kmalloc(bytes);
    if (!g_back) {
        return false;
    }
    memcpy(g_back, g_fb, bytes);
    return true;
}

bool fb_backbuffer_enabled(void) {
    return g_back != 0;
}

void fb_present(void) {
    if (!g_fb || !g_back) {
        return;
    }
    size_t bytes = framebuffer_bytes();
    if (bytes == 0) {
        return;
    }
    memcpy(g_fb, g_back, bytes);
}

void fb_present_region(int x, int y, int w, int h) {
    if (!g_fb || !g_back || w <= 0 || h <= 0) {
        return;
    }

    int x0 = x;
    int y0 = y;
    int x1 = x + w;
    int y1 = y + h;

    if (x0 < 0) {
        x0 = 0;
    }
    if (y0 < 0) {
        y0 = 0;
    }
    if (x1 > (int)g_width) {
        x1 = (int)g_width;
    }
    if (y1 > (int)g_height) {
        y1 = (int)g_height;
    }
    if (x0 >= x1 || y0 >= y1) {
        return;
    }

    size_t bpp = bytes_per_pixel();
    size_t row_bytes = (size_t)(x1 - x0) * bpp;
    for (int py = y0; py < y1; py++) {
        uint8_t *dst = g_fb + (size_t)py * g_pitch + (size_t)x0 * bpp;
        uint8_t *src = g_back + (size_t)py * g_pitch + (size_t)x0 * bpp;
        memcpy(dst, src, row_bytes);
    }
}

uint32_t fb_width(void) {
    return g_width;
}

uint32_t fb_height(void) {
    return g_height;
}

void fb_put_pixel(uint32_t x, uint32_t y, uint32_t color) {
    if (!g_fb || x >= g_width || y >= g_height) {
        return;
    }
    put_pixel_on_surface(fb_surface(), x, y, color);
}

void fb_put_pixel_front(uint32_t x, uint32_t y, uint32_t color) {
    if (!g_fb || x >= g_width || y >= g_height) {
        return;
    }
    put_pixel_on_surface(g_fb, x, y, color);
}

void fb_clear(uint32_t color) {
    if (!g_fb) {
        return;
    }

    uint8_t *surface = fb_surface();
    if (g_bpp == 32) {
        uint32_t px = pack_color32(color);
        for (uint32_t y = 0; y < g_height; y++) {
            uint32_t *row = (uint32_t *)(surface + (size_t)y * g_pitch);
            for (uint32_t x = 0; x < g_width; x++) {
                row[x] = px;
            }
        }
        return;
    }

    if (g_bpp == 24) {
        uint8_t b = (uint8_t)(color & 0xFFu);
        uint8_t g = (uint8_t)((color >> 8) & 0xFFu);
        uint8_t r = (uint8_t)((color >> 16) & 0xFFu);
        for (uint32_t y = 0; y < g_height; y++) {
            uint8_t *row = surface + (size_t)y * g_pitch;
            for (uint32_t x = 0; x < g_width; x++) {
                uint8_t *px = row + x * 3u;
                px[0] = b;
                px[1] = g;
                px[2] = r;
            }
        }
        return;
    }

    if (g_bpp == 16) {
        uint16_t px = pack_color565(color);
        for (uint32_t y = 0; y < g_height; y++) {
            uint16_t *row = (uint16_t *)(surface + (size_t)y * g_pitch);
            for (uint32_t x = 0; x < g_width; x++) {
                row[x] = px;
            }
        }
        return;
    }

    for (uint32_t y = 0; y < g_height; y++) {
        for (uint32_t x = 0; x < g_width; x++) {
            fb_put_pixel(x, y, color);
        }
    }
}

void fb_fill_rect(int x, int y, int w, int h, uint32_t color) {
    if (!g_fb || w <= 0 || h <= 0) {
        return;
    }

    int x0 = x;
    int y0 = y;
    int x1 = x + w;
    int y1 = y + h;

    if (x0 < 0) {
        x0 = 0;
    }
    if (y0 < 0) {
        y0 = 0;
    }
    if (x1 > (int)g_width) {
        x1 = (int)g_width;
    }
    if (y1 > (int)g_height) {
        y1 = (int)g_height;
    }
    if (x0 >= x1 || y0 >= y1) {
        return;
    }

    uint8_t *surface = fb_surface();
    uint32_t width = (uint32_t)(x1 - x0);

    if (g_bpp == 32) {
        uint32_t px = pack_color32(color);
        for (int py = y0; py < y1; py++) {
            uint32_t *row = (uint32_t *)(surface + (size_t)py * g_pitch) + x0;
            for (uint32_t i = 0; i < width; i++) {
                row[i] = px;
            }
        }
        return;
    }

    if (g_bpp == 24) {
        uint8_t b = (uint8_t)(color & 0xFFu);
        uint8_t g = (uint8_t)((color >> 8) & 0xFFu);
        uint8_t r = (uint8_t)((color >> 16) & 0xFFu);
        for (int py = y0; py < y1; py++) {
            uint8_t *row = surface + (size_t)py * g_pitch + (size_t)x0 * 3u;
            for (uint32_t i = 0; i < width; i++) {
                uint8_t *px = row + i * 3u;
                px[0] = b;
                px[1] = g;
                px[2] = r;
            }
        }
        return;
    }

    if (g_bpp == 16) {
        uint16_t px = pack_color565(color);
        for (int py = y0; py < y1; py++) {
            uint16_t *row = (uint16_t *)(surface + (size_t)py * g_pitch) + x0;
            for (uint32_t i = 0; i < width; i++) {
                row[i] = px;
            }
        }
        return;
    }

    for (int py = y0; py < y1; py++) {
        for (int px = x0; px < x1; px++) {
            fb_put_pixel((uint32_t)px, (uint32_t)py, color);
        }
    }
}

void fb_draw_char(int x, int y, char c, uint32_t fg, uint32_t bg) {
    uint8_t glyph = (uint8_t)c;
    for (int row = 0; row < 8; row++) {
        uint8_t bits = font8x8_basic[glyph][row];
        for (int col = 0; col < 8; col++) {
            uint32_t color = (bits & (1U << (7 - col))) ? fg : bg;
            fb_put_pixel((uint32_t)(x + col), (uint32_t)(y + row), color);
        }
    }
}

void fb_draw_text(int x, int y, const char *text, uint32_t fg, uint32_t bg) {
    int cx = x;
    int cy = y;
    while (*text) {
        if (*text == '\n') {
            cx = x;
            cy += 9;
            text++;
            continue;
        }
        fb_draw_char(cx, cy, *text, fg, bg);
        cx += 8;
        text++;
    }
}
