# QuartzOS

QuartzOS is a monolithic 64-bit desktop operating system for x86_64 PCs.
It boots with Limine (BIOS + UEFI), initializes a custom kernel, mounts a custom filesystem image, runs a CLI shell, and renders a graphical desktop with mouse-driven windows.

## Kernel architecture

**Kernel type:** Monolithic kernel

Why this design:
- Low overhead for early-stage OS development.
- Direct in-kernel driver model (keyboard, mouse, timer, ATA, framebuffer).
- Simpler syscall and scheduler bring-up while still providing user mode execution for apps.

### High-level architecture

```text
+-------------------------------------------------------------+
|                        User Space                           |
|   ELF apps (/bin/greeter.. /bin/heartbeat) in Ring 3       |
|   via iretq + int 0x80                                      |
+---------------------------+---------------------------------+
                            | Syscalls (int 0x80)
+---------------------------v---------------------------------+
|                       Kernel Space                          |
| Shell | GUI | Window Manager | FS | Scheduler | Syscalls    |
| PMM | VMM | Heap | IDT/GDT/TSS | PIT | PS/2 | ATA | PCI/e1000 |
| SMP bootstrap + AP work queue scheduler (Limine MP)         |
+---------------------------+---------------------------------+
                            |
+---------------------------v---------------------------------+
|                   Limine Bootloader Layer                  |
|      BIOS + UEFI boot, framebuffer, memmap, modules        |
+---------------------------+---------------------------------+
                            |
+---------------------------v---------------------------------+
|                         Hardware                            |
|      x86_64 CPU, RAM, PS/2, PIT, VGA/Framebuffer, IDE      |
+-------------------------------------------------------------+
```

## Boot process

1. Firmware starts Limine (BIOS or UEFI).
2. Limine loads `boot/kernel.elf` and `boot/rootfs.sfs` module.
3. Kernel entry (`boot/entry.asm`) sets stack and calls `kernel_main()`.
4. Kernel validates Limine protocol revision and grabs:
   - Framebuffer
   - HHDM offset
   - Memory map
   - Rootfs module
   - Multiprocessor table
5. Kernel initializes:
   - GDT + TSS (ring transitions)
   - IDT + ISR/IRQ stubs
   - PIC + PIT
   - Keyboard + Mouse + ATA
   - PMM + VMM + Heap
   - PCI + e1000 NIC
   - SMP AP startup and rendezvous
   - Filesystem, scheduler, shell, GUI
6. Interrupts are enabled and scheduler runs GUI + shell tasks.

## Implemented subsystems

### Interrupts and timer
- Full IDT setup in `kernel/idt.c`.
- Exception handling for vectors 0-31.
- PIC remap and IRQ handling (32-47).
- PIT timer tick at 100 Hz.
- NIC IRQ handling for e1000 (runtime PCI IRQ line).
- `int 0x80` syscall gate with DPL=3 for user programs.

### Memory system
- **PMM:** bitmap allocator from Limine memmap.
- **VMM:** 4-level page mapping over current CR3.
- **Heap:** expandable kernel heap (`kmalloc`, `kfree`, `kcalloc`).
- Kernel/user page permissions supported (`VMM_USER`, `VMM_WRITE`, `VMM_NX`).

### Process and scheduler
- Cooperative round-robin kernel task scheduler (`process/task.c`).
- Context switching in assembly (`process/switch.asm`).
- Kernel tasks run shell and GUI concurrently.
- User ELF execution path with ring3 transition (`process/user.c`, `process/user_enter.asm`).
- SMP startup path with AP bring-up through Limine MP (`kernel/main.c`).
- AP work-queue scheduler used for parallel packet processing (`kernel/mp.c`, `net/net.c`).

### Filesystem
- Custom **SFS** filesystem (`filesystem/sfs.c`).
- Supports:
  - Directories
  - File read
  - File write
  - File existence checks
- Persistence backend on ATA disk image (`sfs_attach_block_device`, `sfs_sync`).
- Rootfs loaded from Limine module generated by `tools/mkrootfs.py`.

### Drivers
- Serial COM1 debug output.
- Framebuffer graphics driver with primitives:
  - Pixel
  - Rectangle
  - Text rendering
- PIT timer driver.
- PS/2 keyboard driver.
- PS/2 mouse driver.
- ATA PIO disk driver (LBA28 read/write).
- PCI config-space scanner (`drivers/pci.c`).
- Intel e1000 network driver with TX/RX rings (`drivers/e1000.c`).
- IPv4 networking stack with ARP, ICMP echo, and minimal TCP (`net/net.c`).

### CLI shell
Implemented in `kernel/shell.c`.

Commands:
- `help`
- `ls [path]`
- `cd <path>`
- `cat <file>`
- `write <file> <text>`
- `mkdir <path>`
- `apps [find <text>]`
- `run <elf>`
- `sync`
- `cpuinfo`
- `netinfo`
- `ifconfig`
- `ping <ip>`
- `tcplisten <port>`
- `tcpsend <ip> <port> <text>`
- `clear`
- `gui` (toggle console overlay)
- `license status`
- `license verify <key>`
- `license activate <key>`
- `license deactivate`
- `license reload`
- `mouse status`
- `mouse invertx <on|off>`
- `mouse inverty <on|off>`
- `mouse center`
- `diskread`

### GUI desktop
Implemented in `gui/gui.c`.

Features:
- Desktop background + top bar
- Mouse cursor rendering
- Basic window manager
- Window dragging by title bar
- Close button on windows
- Terminal overlay integration for shell output

### Application system
- ELF64 loader (`process/user.c`).
- User apps launched by shell (`run /bin/<name>`).
- 20 named demo apps in `/bin`:
  `greeter`, `banner`, `counter`, `fibonacci`, `primes`,
  `table`, `spinner`, `pulse`, `progress`, `matrix`,
  `zigzag`, `checker`, `stairs`, `diamond`, `quotes`,
  `weekdays`, `stats`, `hexview`, `wave`, `heartbeat`
- 500 generated ecosystem apps from:
  `assets/ecosystem/QuartzOS_Ecosystem_Apps_No_Monetization.txt`
  - App binary naming: `eco001_*` ... `eco500_*`
  - Browse with `apps` or filter with `apps find <text>`
- Syscalls via `int 0x80`:
  - `SYS_WRITE`
  - `SYS_EXIT`
  - `SYS_YIELD`

### Security model
- Ring3 execution for user apps via `iretq`.
- Syscall entry point (`int 0x80`) controlled by kernel.
- Kernel pages are supervisor mappings; user mappings marked with `VMM_USER`.
- User stack is explicitly mapped in user virtual space.
- Kernel-side signed license verification with dual-format support (`QOS1` legacy + `QOS2` HMAC-SHA256).
- Revocation enforcement via `/etc/licenses.revoked`.
- Tamper-evident license state file (HMAC-protected `/etc/license.state`).
- Activation abuse protection with failed-attempt windowing + lockout.

### License system
- Registry file in rootfs: `/etc/licenses.db`.
- Revocation file in rootfs: `/etc/licenses.revoked`.
- Active state file: `/etc/license.state`.
- Ecosystem catalog files in rootfs:
  - `/etc/ecosystem_apps.txt`
  - `/etc/ecosystem_index.csv`
  - `/etc/ecosystem_index.txt`
- `run` requires an active valid license.
- Default test keys included in rootfs:
  - `QOS1-00000001-0001-D9C61476`
  - `QOS2-0A0B0C0D-0001-10203040-2BCE3A12C18C12DB`
- Password-protected issuer app:
  `license_issuer/issue_license.py`

## Project layout

```text
boot/          boot config, linker script, entry asm
kernel/        core kernel (main, idt, gdt, syscalls, shell, console)
drivers/       hardware drivers
memory/        pmm/vmm/heap
process/       scheduler, context switch, user-mode transition
net/           ARP/IPv4/ICMP/TCP stack
filesystem/    custom SFS
gui/           desktop + window manager
apps/          userspace app(s)
assets/        rootfs seed assets (including license database)
license_issuer/password-protected license issuer app
lib/           freestanding libc subset
tools/         build helpers (rootfs builder, qemu runner)
include/       headers
Makefile       build + ISO pipeline
```

## Build requirements

Install these tools:
- `x86_64-elf-gcc` and `x86_64-elf-ld` (or `clang` + `ld.lld` targeting ELF)
- `nasm`
- `xorriso`
- `git`
- `python3`
- `qemu-system-x86_64` (for emulation)

## Build instructions

```bash
make iso
```

This builds:
- Kernel ELF
- 520 ELF apps in `/bin` (20 demo + 500 ecosystem)
- `rootfs.sfs`
- Persistent data disk image: `build/quartzos_disk.img`
- Limine boot files
- Bootable ISO: `build/quartzos.iso`

For persistent filesystem backing:

```bash
make disk
```

## Run instructions

### QEMU

```bash
make run
```

Or:

```bash
./tools/run-qemu.sh build/quartzos.iso
```

With explicit disk image:

```bash
./tools/run-qemu.sh build/quartzos.iso build/quartzos_disk.img
```

SMP test run:

```bash
qemu-system-x86_64 -M pc -accel tcg -smp 4 -m 1024 \
  -cdrom build/quartzos.iso \
  -drive file=build/quartzos_disk.img,format=raw,if=ide,index=0 \
  -netdev user,id=net0 -device e1000,netdev=net0 \
  -serial stdio
```

### VirtualBox

1. Create a new 64-bit VM.
2. Attach `build/quartzos.iso` as optical media.
3. Enable EFI if testing UEFI path.
4. Boot VM.

### VMware

1. Create a new x86_64 VM.
2. Use `build/quartzos.iso` as CD/DVD boot media.
3. Boot VM (BIOS or UEFI firmware both supported by Limine image).

### Real hardware

Write ISO to USB and boot (BIOS or UEFI firmware):

```bash
sudo dd if=build/quartzos.iso of=/dev/sdX bs=4M status=progress conv=fsync
```

(Replace `/dev/sdX` with your USB device.)

## Notes

- The default `make run` path boots from ISO and attaches `build/quartzos_disk.img` for persistent SFS writes.
- SMP APs are brought online and run a shared work queue for kernel jobs.
- Networking includes ARP + IPv4 + ICMP ping + a minimal TCP implementation (echo/listen + active text send).
- Before launching apps, activate a key:
  - `license activate QOS1-00000001-0001-D9C61476`
  - `license activate QOS2-0A0B0C0D-0001-10203040-2BCE3A12C18C12DB`
